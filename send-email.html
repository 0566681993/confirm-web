<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Gửi yêu cầu truy cập</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
</head>
<body>
  <h1>Gửi yêu cầu truy cập</h1>
  <form id="accessForm">
    <label>Email:</label>
    <input type="email" id="email" required />
    <br><br>
    <button type="submit">Gửi yêu cầu truy cập</button>
  </form>

  <p id="message"></p>

  <script>
    const supabaseUrl = 'https://rtxdvcvzkepogytpnvsi.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ0eGR2Y3Z6a2Vwb2d5dHBudnNpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMyNzI1NzksImV4cCI6MjA2ODg0ODU3OX0.SG_q8rnfAA7LAFoYYQyPsUFZPqsh1C13GbkGln4Z3JU';
    const supabase = supabase.createClient(supabaseUrl, supabaseKey);

    const deviceId = (() => {
      const key = 'device_id';
      let id = localStorage.getItem(key);
      if (!id) {
        id = crypto.randomUUID();
        localStorage.setItem(key, id);
      }
      return id;
    })();

    document.getElementById('accessForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('email').value.trim();
      const message = document.getElementById('message');
      message.textContent = 'Đang kiểm tra...';

      try {
        // Kiểm tra xem đã tồn tại chưa
        const { data: existing, error: checkError } = await supabase
          .from('approved_access')
          .select('*')
          .eq('email', email)
          .eq('device_id', deviceId);

        if (checkError) {
          console.error('Lỗi kiểm tra:', checkError);
          message.textContent = 'Lỗi kiểm tra cơ sở dữ liệu.';
          return;
        }

        if (existing.length > 0) {
          message.textContent = 'Email và thiết bị đã đăng ký rồi.';
          return;
        }

        // Chưa có → thêm mới
        const { error: insertError } = await supabase
          .from('approved_access')
          .insert([{ email, device_id: deviceId }]);

        if (insertError) {
          console.error('Lỗi ghi vào DB:', insertError);
          message.textContent = 'Gửi yêu cầu thất bại.';
          return;
        }

        message.textContent = 'Gửi yêu cầu thành công!';
      } catch (err) {
        console.error('Lỗi không xác định:', err);
        message.textContent = 'Đã xảy ra lỗi.';
      }
    });
  </script>
</body>
</html>
