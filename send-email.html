<script>
  async function sendEmail() {
    const email = document.getElementById("email").value.trim();
    const deviceId = getDeviceId();
    const statusEl = document.getElementById("status");

    if (!email) {
      alert("Vui lòng nhập email.");
      return;
    }

    const supabaseUrl = "https://rtxdvcvzkepogytpnvsi.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."; // thay bằng key thật của bạn

    // Kiểm tra xem đã tồn tại chưa
    try {
      const checkRes = await fetch(`${supabaseUrl}/rest/v1/approved_access?email=eq.${email}&device_id=eq.${deviceId}`, {
        headers: {
          apikey: supabaseKey,
          Authorization: `Bearer ${supabaseKey}`,
          Accept: "application/json"
        }
      });

      const existing = await checkRes.json();

      if (existing.length > 0) {
        statusEl.textContent = "⚠️ Email và thiết bị đã tồn tại trong hệ thống.";
        return;
      }
    } catch (err) {
      console.error("Lỗi kiểm tra tồn tại:", err);
      statusEl.textContent = "❌ Không kiểm tra được dữ liệu. Vui lòng thử lại.";
      return;
    }

    // Nếu chưa có thì gửi email và ghi vào supabase
    try {
      await emailjs.send("0566681993", "0376425426", {
        email: email,
        device_id: deviceId,
        folder_name: folderName
      });

      // Ghi vào Supabase
      const res = await fetch(`${supabaseUrl}/rest/v1/approved_access`, {
        method: "POST",
        headers: {
          apikey: supabaseKey,
          Authorization: `Bearer ${supabaseKey}`,
          "Content-Type": "application/json",
          Prefer: "return=minimal"
        },
        body: JSON.stringify({
          email: email,
          device_id: deviceId
        })
      });

      if (res.ok) {
        statusEl.textContent = "✅ Đã gửi yêu cầu và lưu thành công!";
      } else {
        const errorText = await res.text();
        throw new Error(errorText);
      }
    } catch (error) {
      console.error("Lỗi gửi hoặc ghi:", error);
      statusEl.textContent = "❌ Gửi hoặc ghi dữ liệu thất bại.";
    }
  }
</script>
