<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>G·ª¨I ƒêƒÇNG K√ù ƒê·ªåC TRUY·ªÜN</title>
<style>
  body{
    font-family: Arial;
    padding:20px;
    background:#f4f4f4;
  }
  .box{
    background:#fff;
    padding:15px;
    border-radius:6px;
    margin:10px 0;
    word-break: break-all;
  }
  input, button{
    padding:8px;
    font-size:14px;
    margin-top:5px;
    width:100%;
    max-width:360px;
  }
  button{
    background:#ff4d4d;
    color:#fff;
    border:none;
    border-radius:4px;
    cursor:pointer;
  }
  button:hover{ background:#e60000; }
  #status{ margin-top:10px; font-weight:bold; }
</style>
</head>

<body>

<h2>üß™ G·ª¨I Y√äU C·∫¶U ƒê·ªåC TRUY·ªÜN</h2>

<div class="box">
  <b>MaÃÉ thi√™ÃÅt biÃ£:</b>
  <div id="deviceId">...</div>
</div>

<div class="box">
  <b>TriÃÄnh duy√™Ã£t:</b>
  <div id="browserName">...</div>
</div>

<div class="box" >
  <b>T√™n truy·ªán:</b>
  <div id="folderNameDisplay">...</div>
</div>

<div class="box">
  <b>Email / T√™n:</b>
  <input type="email" id="email" placeholder="Nh·∫≠p email ho·∫∑c t√™n">
  <button onclick="sendRequest()">üì® G·ª≠i y√™u c·∫ßu</button>
  <div id="status"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
/* ========= CONFIG ========= */
const SUPABASE_URL = "https://rtxdvcvzkepogytpnvsi.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ0eGR2Y3Z6a2Vwb2d5dHBudnNpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMyNzI1NzksImV4cCI6MjA2ODg0ODU3OX0.SG_q8rnfAA7LAFoYYQyPsUFZPqsh1C13GbkGln4Z3JU";

const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ========= DEVICE ID ========= */
function getDeviceId(){
  let id = localStorage.getItem("deviceId");
  if(!id){
    id = crypto.randomUUID();
    localStorage.setItem("deviceId", id);
  }
  return id;
}

/* ========= BROWSER ========= */
function getBrowser(){
  const ua = navigator.userAgent;
  let name = "Unknown";
  if(ua.includes("Edg")) name = "Microsoft Edge";
  else if(ua.includes("Chrome")) name = "Google Chrome";
  else if(ua.includes("Firefox")) name = "Mozilla Firefox";
  else if(ua.includes("Safari")) name = "Safari";
  return { name, ua };
}

/* ========= FOLDER ID ========= */
function extractFolderId(folderName){
  const match = folderName.match(/^(\d+)/); // l·∫•y s·ªë ·ªü ƒë·∫ßu chu·ªói
  return match ? parseInt(match[1]) : 0;
}

/* ========= HI·ªÇN TH·ªä ========= */
const deviceId = getDeviceId();
const browser = getBrowser();
const folderName = localStorage.getItem("errorFolderName") || "KH√îNG ROÃÉ TH∆Ø MUÃ£C";
const folderId = extractFolderId(folderName);

document.getElementById("deviceId").textContent = deviceId;
document.getElementById("browserName").textContent = browser.name;
document.getElementById("folderNameDisplay").textContent = folderName;

/* ========= SEND ========= */
async function sendRequest(){
  const email = document.getElementById("email").value.trim();
  const status = document.getElementById("status");

  if(!email){
    status.textContent = "‚ùå Vui l√≤ng nh·∫≠p email.";
    status.style.color = "red";
    return;
  }

  status.textContent = "‚è≥ ƒêang x·ª≠ l√Ω...";
  status.style.color = "#333";

  try {
    // ===== 1Ô∏è‚É£ Ki·ªÉm tra b·∫£n ghi ƒë√£ t·ªìn t·∫°i =====
    const { data: existingRecord, error: checkError } = await supabaseClient
      .from("approved_access")
      .select("id")
      .eq("device_id", deviceId)
      .eq("folder_id", folderId)
      .single();

    if (checkError && checkError.code !== "PGRST116") {
      throw new Error(`L·ªói ki·ªÉm tra b·∫£n ghi: ${checkError.message}`);
    }

    if (existingRecord) {
      status.textContent = "‚ö†Ô∏è Y√™u c·∫ßu ƒë√£ t·ªìn t·∫°i, ƒëang ch·ªù duy·ªát.";
      status.style.color = "orange";
      return; // Kh√¥ng ghi m·ªõi
    }

    // ===== 2Ô∏è‚É£ Ghi m·ªõi n·∫øu ch∆∞a t·ªìn t·∫°i =====
    const { error: insertError } = await supabaseClient
      .from("approved_access")
      .insert({
        device_id: deviceId,
        name_email: email,
        folder_name: folderName,
        folder_id: folderId,
        brower_name: browser.name,
        approval: false
      });

    if (insertError) throw insertError;

    // ===== 3Ô∏è‚É£ G·ª≠i email =====
    const res = await fetch(
      "https://script.google.com/macros/s/AKfycbyfTdvfQPiuHr2IJg2LncLemvY-H0kyiSDL4ykSVui7Mvd_D97z1V3lvFpyvJ30liJs/exec",
      {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: new URLSearchParams({
          folder_name: folderName,
          folder_id: folderId,
          device_id: deviceId,
          email: email,
          browser: browser.name
        })
      }
    );

    if(!res.ok) throw new Error("G·ª≠i email th·∫•t b·∫°i");

    status.textContent = "‚úÖ ƒê√£ g·ª≠i y√™u c·∫ßu th√†nh c√¥ng!";
    status.style.color = "green";

  } catch(err){
    console.error(err);
    status.textContent = "‚ùå L·ªói: " + err.message;
    status.style.color = "red";
  }
}

document.addEventListener('keydown', function(e) {
    // F12
    if (e.key === 'F12') {
        e.preventDefault();
    }

    // Ctrl + Shift + I / C / J / K
    if (e.ctrlKey && e.shiftKey) {
        const blockedKeys = ['I', 'C', 'J', 'K'];
        if (blockedKeys.includes(e.key.toUpperCase())) {
            e.preventDefault();
        }
    }

    // Ctrl + U (view source)
    if (e.ctrlKey && e.key.toUpperCase() === 'U') {
        e.preventDefault();
    }

    // Ctrl + Shift + E (Firefox dev tools) n·∫øu mu·ªën th√™m
});


</script>

</body>
</html>






