<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Gá»¬I ÄÄ‚NG KÃ Äá»ŒC TRUYá»†N</title>
<style>
  body{
    font-family: Arial;
    padding:20px;
    background:#f4f4f4;
  }
  .box{
    background:#fff;
    padding:15px;
    border-radius:6px;
    margin:10px 0;
    word-break: break-all;
  }
  input, button{
    padding:8px;
    font-size:14px;
    margin-top:5px;
    width:100%;
    max-width:360px;
  }
  button{
    background:#ff4d4d;
    color:#fff;
    border:none;
    border-radius:4px;
    cursor:pointer;
  }
  button:hover{ background:#e60000; }
  #status{ margin-top:10px; font-weight:bold; }
</style>
</head>

<body>

<h2>ğŸ§ª Gá»¬I YÃŠU Cáº¦U Äá»ŒC TRUYá»†N</h2>

<div class="box">
  <b>MaÌƒ thiÃªÌt biÌ£:</b>
  <div id="deviceId">...</div>
</div>

<div class="box">
  <b>TriÌ€nh duyÃªÌ£t:</b>
  <div id="browserName">...</div>
</div>

<div class="box" >
  <b>TÃªn truyá»‡n:</b>
  <div id="folderNameDisplay">...</div>
</div>

<div class="box">
  <b>Email / TÃªn:</b>
  <input type="email" id="email" placeholder="Nháº­p email hoáº·c tÃªn">
  <button onclick="sendRequest()">ğŸ“¨ Gá»­i yÃªu cáº§u</button>
  <div id="status"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
/* ========= CONFIG ========= */
const SUPABASE_URL = "https://rtxdvcvzkepogytpnvsi.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ0eGR2Y3Z6a2Vwb2d5dHBudnNpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMyNzI1NzksImV4cCI6MjA2ODg0ODU3OX0.SG_q8rnfAA7LAFoYYQyPsUFZPqsh1C13GbkGln4Z3JU";

const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ========= DEVICE ID ========= */
function getDeviceId(){
  let id = localStorage.getItem("TEST_DEVICE_ID");
  if(!id){
    id = crypto.randomUUID();
    localStorage.setItem("TEST_DEVICE_ID", id);
  }
  return id;
}

/* ========= BROWSER ========= */
function getBrowser(){
  const ua = navigator.userAgent;
  let name = "Unknown";
  if(ua.includes("Edg")) name = "Microsoft Edge";
  else if(ua.includes("Chrome")) name = "Google Chrome";
  else if(ua.includes("Firefox")) name = "Mozilla Firefox";
  else if(ua.includes("Safari")) name = "Safari";
  return { name, ua };
}

/* ========= FOLDER ID ========= */
function extractFolderId(folderName){
  const match = folderName.match(/(\d+)$/); // láº¥y sá»‘ cuá»‘i lÃ m folder ID
  return match ? parseInt(match[1]) : 0;
}

/* ========= HIá»‚N THá»Š ========= */
const deviceId = getDeviceId();
const browser = getBrowser();
const folderName = localStorage.getItem("errorFolderName") || "KHÃ”NG ROÌƒ THÆ¯ MUÌ£C";
const folderId = extractFolderId(folderName);

document.getElementById("deviceId").textContent = deviceId;
document.getElementById("browserName").textContent = browser.name;
document.getElementById("folderNameDisplay").textContent = folderName;

/* ========= SEND ========= */
async function sendRequest(){
  const email = document.getElementById("email").value.trim();
  const status = document.getElementById("status");

  if(!email){
    status.textContent = "âŒ Vui lÃ²ng nháº­p email.";
    status.style.color = "red";
    return;
  }

  status.textContent = "â³ Äang xá»­ lÃ½...";
  status.style.color = "#333";

  try {
    // ===== 1ï¸âƒ£ Kiá»ƒm tra báº£n ghi Ä‘Ã£ tá»“n táº¡i =====
    const { data: existingRecord, error: checkError } = await supabaseClient
      .from("approved_access")
      .select("id")
      .eq("device_id", deviceId)
      .eq("folder_id", folderId)
      .single();

    if (checkError && checkError.code !== "PGRST116") {
      throw new Error(`Lá»—i kiá»ƒm tra báº£n ghi: ${checkError.message}`);
    }

    if (existingRecord) {
      status.textContent = "âš ï¸ YÃªu cáº§u Ä‘Ã£ tá»“n táº¡i, Ä‘ang chá» duyá»‡t.";
      status.style.color = "orange";
      return; // KhÃ´ng ghi má»›i
    }

    // ===== 2ï¸âƒ£ Ghi má»›i náº¿u chÆ°a tá»“n táº¡i =====
    const { error: insertError } = await supabaseClient
      .from("approved_access")
      .insert({
        device_id: deviceId,
        name_email: email,
        folder_name: folderName,
        folder_id: folderId,
        brower_name: browser.name,
        approval: false
      });

    if (insertError) throw insertError;

    // ===== 3ï¸âƒ£ Gá»­i email =====
    const res = await fetch(
      "https://script.google.com/macros/s/AKfycbyfTdvfQPiuHr2IJg2LncLemvY-H0kyiSDL4ykSVui7Mvd_D97z1V3lvFpyvJ30liJs/exec",
      {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: new URLSearchParams({
          folder_name: folderName,
          folder_id: folderId,
          device_id: deviceId,
          email: email,
          browser: browser.name
        })
      }
    );

    if(!res.ok) throw new Error("Gá»­i email tháº¥t báº¡i");

    status.textContent = "âœ… ÄÃ£ gá»­i yÃªu cáº§u thÃ nh cÃ´ng!";
    status.style.color = "green";

  } catch(err){
    console.error(err);
    status.textContent = "âŒ Lá»—i: " + err.message;
    status.style.color = "red";
  }
}

// NgÄƒn sao chÃ©p & má»Ÿ console  
document.addEventListener('contextmenu', e => e.preventDefault());  
document.addEventListener('keydown', e => {  
  if (e.key === 'F11' ||   
      (e.ctrlKey && e.shiftKey && ['I', 'C', 'J'].includes(e.key)) ||   
      (e.ctrlKey && e.key === 'U')) {  
    e.preventDefault();  
  }  
}); 
</script>

</body>
</html>


