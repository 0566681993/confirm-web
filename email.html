<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>G·ª≠i Y√™u C·∫ßu Truy C·∫≠p</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #f0f0f0;
      text-align: center;
      margin: 0;
    }
    h3 { font-size: clamp(18px, 5vw, 22px); color: #333; margin-bottom: 10px; }
    p { font-size: clamp(14px, 4vw, 16px); color: #666; margin: 10px 0; }
    .folder-name { font-weight: bold; color: #0066cc; }
    input[type="email"] {
      width: 100%; max-width: 300px; padding: 8px; margin: 10px 0;
      border: 1px solid #ccc; border-radius: 3px; font-size: clamp(12px, 3.5vw, 14px);
    }
    .button-container {
      display: flex; justify-content: center; gap: 10px; margin: 10px 0;
    }
    button {
      background: #ff4d4d; color: white; border: none;
      padding: 8px 15px; border-radius: 3px; cursor: pointer;
      font-size: clamp(12px, 3.5vw, 14px);
    }
    button:hover { background: #e60000; }
    #status { color: #333; font-size: clamp(12px, 3.5vw, 14px); }
    #status.success { color: green; }
    #status.error { color: red; }
    @media screen and (max-width: 600px) {
      body { padding: 10px; }
      h3 { font-size: clamp(16px, 4.5vw, 18px); }
      p { font-size: clamp(12px, 3.2vw, 14px); }
      input[type="email"], button {
        font-size: clamp(10px, 3vw, 12px); padding: 6px 10px;
      }
      .button-container { gap: 5px; }
    }
  </style>
</head>
<body>
  <h3>G·ª≠i y√™u c·∫ßu truy c·∫≠p</h3>
  <p id="folderInfo">üìÅ Truy·ªán : <span class="folder-name">...</span></p>
  <input type="email" id="email" placeholder="Nh·∫≠p T√™n ho·∫∑c Email..." />
  <div class="button-container">
    <button onclick="sendEmail()">G·ª≠i y√™u c·∫ßu</button>
    <button onclick="goBack()">Quay l·∫°i trang ch·ªß</button>
  </div>
  <p id="status"></p>
  <h3>Khi ƒë∆∞·ª£c duy·ªát vui l√≤ng ch·ªâ s·ª≠ d·ª•ng tr√¨nh duy·ªát d√πng ƒë·ªÉ g·ª≠i y√™u c·∫ßu ƒë·ªÉ ƒë·ªçc truy·ªán nh√© !</h3>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const folderName = localStorage.getItem('errorFolderName') || 'Kh√¥ng r√µ th∆∞ m·ª•c';
    document.getElementById("folderInfo").innerHTML = `üìÅ Truy·ªán: <span class="folder-name">${folderName}</span>`;

    // Supabase config
    const SUPABASE_URL = 'https://rtxdvcvzkepogytpnvsi.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    function getDeviceId() {
      let id = localStorage.getItem("deviceId");
      if (!id) {
        id = crypto.randomUUID();
        localStorage.setItem("deviceId", id);
      }
      return id;
    }

    function extractFolderId(folderName) {
      const match = folderName.match(/^(\d+)\./);
      return match ? parseInt(match[1]) : null;
    }

    async function sendEmail() {
      const email = document.getElementById("email").value.trim();
      const deviceId = getDeviceId();
      const folderId = extractFolderId(folderName);
      const statusEl = document.getElementById("status");

      if (!email) {
        statusEl.textContent = "Vui l√≤ng nh·∫≠p email.";
        statusEl.className = "error";
        return;
      }

      if (!folderId) {
        statusEl.textContent = "Kh√¥ng th·ªÉ tr√≠ch xu·∫•t folder_id t·ª´ t√™n th∆∞ m·ª•c.";
        statusEl.className = "error";
        return;
      }

      try {
        const { data: existingRecord, error: checkError } = await supabase
          .from('approved_access')
          .select('id')
          .eq('device_id', deviceId)
          .eq('folder_id', folderId)
          .single();

        if (checkError && checkError.code !== 'PGRST116') {
          throw new Error(`L·ªói ki·ªÉm tra b·∫£n ghi: ${checkError.message}`);
        }

        if (existingRecord) {
          statusEl.textContent = "ƒê√£ g·ª≠i y√™u c·∫ßu, ƒëang ch·ªù duy·ªát.";
          statusEl.className = "success";
          return;
        }

        const { error: insertError } = await supabase
          .from('approved_access')
          .insert({
            device_id: deviceId,
            folder_id: folderId,
            folder_name: folderName,
            name_email: email,
            approval: false
          });

        if (insertError) {
          throw new Error(`L·ªói ghi d·ªØ li·ªáu: ${insertError.message}`);
        }

        // G·ª≠i email qua Google Apps Script
        await fetch("https://script.google.com/macros/s/AKfycbyfTdvfQPiuHr2IJg2LncLemvY-H0kyiSDL4ykSVui7Mvd_D97z1V3lvFpyvJ30liJs/exec", {
          method: "POST",
          headers: {
            "Content-Type": "application/x-www-form-urlencoded"
          },
          body: new URLSearchParams({
            email: email,
            device_id: deviceId,
            folder_name: folderName
          })
        });

        statusEl.textContent = "‚úÖ ƒê√£ g·ª≠i y√™u c·∫ßu th√†nh c√¥ng!";
        statusEl.className = "success";
      } catch (error) {
        console.error("L·ªói:", error);
        statusEl.textContent = "‚ùå G·ª≠i y√™u c·∫ßu th·∫•t b·∫°i. Vui l√≤ng th·ª≠ l·∫°i." + (error.message || error);
        statusEl.className = "error";
      }
    }

    function goBack() {
      window.location.href = 'index.html';
    }

    // NgƒÉn sao ch√©p & m·ªü console
    document.addEventListener('contextmenu', e => e.preventDefault());
    document.addEventListener('keydown', e => {
      if (e.key === 'F12' || 
          (e.ctrlKey && e.shiftKey && ['I', 'C', 'J'].includes(e.key)) || 
          (e.ctrlKey && e.key === 'U')) {
        e.preventDefault();
      }
    });
    document.addEventListener('copy', e => e.preventDefault());
    document.addEventListener('dragstart', e => e.preventDefault());
  </script>
</body>
</html>
