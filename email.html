<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>G·ª≠i Y√™u C·∫ßu Truy C·∫≠p</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #f0f0f0;
      text-align: center;
      margin: 0;
    }
    h3 { font-size: clamp(18px, 5vw, 22px); color: #333; margin-bottom: 10px; }
    p { font-size: clamp(14px, 4vw, 16px); color: #666; margin: 10px 0; }
    .folder-name { font-weight: bold; color: #0066cc; }
    input[type="email"] {
      width: 100%; max-width: 300px; padding: 8px; margin: 10px 0;
      border: 1px solid #ccc; border-radius: 3px;
    }
    .button-container {
      display: flex; justify-content: center; gap: 10px; margin: 10px 0;
    }
    button {
      background: #ff4d4d; color: white; border: none;
      padding: 8px 15px; border-radius: 3px; cursor: pointer;
    }
    button:hover { background: #e60000; }
    #status.success { color: green; }
    #status.error { color: red; }
  </style>
</head>

<body>
  <h3>G·ª≠i y√™u c·∫ßu truy c·∫≠p</h3>

  <p id="folderInfo">üìÅ Truy·ªán: <span class="folder-name">...</span></p>
  <p>üì± M√£ thi·∫øt b·ªã: <span id="deviceIdDisplay">...</span></p>
  <p>üåè Tr√¨nh duy·ªát: <span id="browser-Name">...</span></p>

  <input type="email" id="email" placeholder="Nh·∫≠p T√™n ho·∫∑c Email..." />

  <div class="button-container">
    <button onclick="sendEmail()">G·ª≠i y√™u c·∫ßu</button>
    <button onclick="goBack()">Quay l·∫°i trang ch·ªß</button>
  </div>

  <p id="status"></p>

  <h3>Khi ƒë∆∞·ª£c duy·ªát vui l√≤ng ch·ªâ s·ª≠ d·ª•ng tr√¨nh duy·ªát d√πng ƒë·ªÉ g·ª≠i y√™u c·∫ßu ƒë·ªÉ ƒë·ªçc truy·ªán nh√© !</h3>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    /* ================= H√ÄM TI·ªÜN √çCH ‚Äì ƒê∆ØA L√äN ƒê·∫¶U (FIX L·ªñI) ================= */

    function getDeviceId() {
      let id = localStorage.getItem("deviceId");
      if (!id) {
        id = crypto.randomUUID();
        localStorage.setItem("deviceId", id);
      }
      return id;
    }

    function getBrowserInfo() {
      const ua = navigator.userAgent;
      let name = "Unknown";

      if (ua.includes("Edg")) name = "Microsoft Edge";
      else if (ua.includes("Chrome")) name = "Google Chrome";
      else if (ua.includes("Firefox")) name = "Mozilla Firefox";
      else if (ua.includes("Safari") && !ua.includes("Chrome")) name = "Apple Safari";
      else if (ua.includes("OPR") || ua.includes("Opera")) name = "Opera";

      return { name, userAgent: ua };
    }

    function extractFolderId(folderName) {
      const match = folderName.match(/^(\d+)/);
      return match ? parseInt(match[1]) : null;
    }

    /* ================= L·∫§Y D·ªÆ LI·ªÜU T·ª™ INDEX.HTML ================= */

    const folderName = localStorage.getItem("errorFolderName") || "Kh√¥ng r√µ th∆∞ m·ª•c";
    document.getElementById("folderInfo").innerHTML =
      `üìÅ Truy·ªán: <span class="folder-name">${folderName}</span>`;

    const deviceId = getDeviceId();
    document.getElementById("deviceIdDisplay").textContent = deviceId;

    const browser = getBrowserInfo();
    document.getElementById("browser-Name").textContent = browser.name;

    /* ================= SUPABASE ================= */

    const SUPABASE_URL = "https://rtxdvcvzkepogytpnvsi.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    /* ================= G·ª¨I EMAIL ================= */

    async function sendEmail() {
      const emailInput = document.getElementById("email").value.trim();
      const statusEl = document.getElementById("status");
      const folderId = extractFolderId(folderName);

      if (!emailInput) {
        statusEl.textContent = "Vui l√≤ng nh·∫≠p email.";
        statusEl.className = "error";
        return;
      }

      try {
        const { data: existing, error: checkError } = await supabase
          .from("approved_access")
          .select("id")
          .eq("device_id", deviceId)
          .eq("folder_id", folderId)
          .single();

        if (existing) {
          statusEl.textContent = "Y√™u c·∫ßu ƒë√£ t·ªìn t·∫°i, ƒëang ch·ªù duy·ªát.";
          statusEl.className = "success";
          return;
        }

        await supabase.from("approved_access").insert({
          device_id: deviceId,
          folder_id: folderId,
          folder_name: folderName,
          name_email: emailInput,
          browser_name: browser.name,
          approval: false
        });

        await fetch("https://script.google.com/macros/s/AKfycbyfTdvfQPiuHr2IJg2LncLemvY-H0kyiSDL4ykSVui7Mvd_D97z1V3lvFpyvJ30liJs/exec", {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: new URLSearchParams({
            email: emailInput,
            device_id: deviceId,
            folder_name: folderName,
            browser: browser.name
          })
        });

        statusEl.textContent = "‚úÖ ƒê√£ g·ª≠i y√™u c·∫ßu. Vui l√≤ng ƒë·ª£i admin duy·ªát.";
        statusEl.className = "success";

      } catch (err) {
        console.error(err);
        statusEl.textContent = "‚ùå G·ª≠i y√™u c·∫ßu th·∫•t b·∫°i.";
        statusEl.className = "error";
      }
    }

    function goBack() {
      window.location.href = "index.html";
    }
  </script>
</body>
</html>
